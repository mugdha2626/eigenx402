<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EigenX402 Payment Gateway - Live Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .hero {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .hero h1 {
      font-size: 42px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .hero p {
      font-size: 18px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .info-box {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 20px;
      border-radius: 12px;
      color: white;
      margin-bottom: 30px;
    }

    .info-box h3 {
      font-size: 16px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .info-box code {
      background: rgba(0, 0, 0, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .demo-section {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #111827;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
    }

    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .result {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid #e5e7eb;
    }

    .result h4 {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }

    .result pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }
  </style>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="hero">
      <h1>EigenX402 Payment Gateway</h1>
      <p>AI-powered service with crypto payments in your TEE</p>
      <span class="badge">x402 Protocol · Base Sepolia · $0.05 USDC</span>
    </div>

    <div class="info-box">
      <h3>Service Information</h3>
      <p><strong>TEE Service URL:</strong> <code>http://35.227.35.220:8080</code></p>
      <p><strong>Endpoint:</strong> <code>/api/generate-text</code></p>
      <p><strong>Price:</strong> 0.05 USDC per request</p>
      <p><strong>Network:</strong> Base Sepolia (Chain ID: 84532)</p>
    </div>

    <div class="demo-section">
      <h2 class="section-title">Try the AI Service</h2>

      <div class="form-group">
        <label for="prompt">Enter your prompt:</label>
        <textarea id="prompt" placeholder="Ask me anything...">What is the meaning of life?</textarea>
      </div>

      <div class="form-group">
        <label for="seed">Seed (optional):</label>
        <input type="number" id="seed" placeholder="42" value="42">
      </div>

      <button id="submitBtn" onclick="handleSubmit()">
        Connect Wallet & Pay 0.05 USDC
      </button>

      <div id="status"></div>
      <div id="result"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://35.227.35.220:8080';
    const USDC_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e';
    const CHAIN_ID = 84532; // Base Sepolia

    let provider;
    let signer;

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = message;
    }

    function showResult(data) {
      const resultDiv = document.getElementById('result');
      resultDiv.className = 'result';
      resultDiv.innerHTML = `
        <h4>Response:</h4>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
    }

    async function handleSubmit() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;

      try {
        // Connect wallet
        showStatus('Connecting to MetaMask...', 'info');

        if (typeof window.ethereum === 'undefined') {
          throw new Error('MetaMask is not installed! Please install MetaMask to continue.');
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();

        const userAddress = await signer.getAddress();
        showStatus(`Connected: ${userAddress}<br>Checking network...`, 'info');

        // Check network
        const network = await provider.getNetwork();
        if (network.chainId !== CHAIN_ID) {
          showStatus('Switching to Base Sepolia network...', 'info');
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x14a34' }], // 84532 in hex
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              // Network not added, add it
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: '0x14a34',
                  chainName: 'Base Sepolia',
                  nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                  rpcUrls: ['https://sepolia.base.org'],
                  blockExplorerUrls: ['https://sepolia.basescan.org']
                }],
              });
            } else {
              throw switchError;
            }
          }
        }

        // Get form data
        const prompt = document.getElementById('prompt').value;
        const seed = parseInt(document.getElementById('seed').value) || 42;

        // Make request to service
        showStatus('Sending request to TEE service...', 'info');

        const response = await fetch(`${API_URL}/api/generate-text`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt, seed })
        });

        const data = await response.json();

        if (response.status === 402) {
          // Payment required
          showStatus('Payment required. Please approve USDC payment in MetaMask...', 'info');

          // TODO: Implement x402 payment flow here
          // This would require the full x402 SDK

          showStatus(`
            <strong>Payment Required!</strong><br><br>
            This demo needs the full x402 payment SDK to complete the payment flow.<br><br>
            <strong>What happens next:</strong><br>
            1. You would sign a USDC authorization (EIP-3009)<br>
            2. The payment proof would be sent with the request<br>
            3. The TEE would verify and process your request<br><br>
            <strong>Payment Details:</strong><br>
            Amount: ${data.paymentRequired.amount} USDC<br>
            To: ${data.paymentRequired.payTo}<br>
            Network: ${data.paymentRequired.network}
          `, 'info');

        } else if (response.ok) {
          showStatus('✅ Success!', 'success');
          showResult(data);
        } else {
          throw new Error(data.error || 'Request failed');
        }

      } catch (error) {
        console.error('Error:', error);
        showStatus(`❌ Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
