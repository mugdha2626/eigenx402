# ðŸš€ Deploy x402 Service to EigenCompute TEE

**Step-by-step guide to deploying your payment-protected API to EigenCompute**

## Prerequisites âœ…

- [x] EigenX CLI installed
- [x] Docker installed and running
- [ ] Docker Hub account (or GitHub Container Registry)
- [ ] Mainnet ETH (or Sepolia ETH for testing)

## Step-by-Step Deployment

### Step 1: Check Your Setup (30 seconds)

```bash
# Verify Docker is running
docker --version
docker ps

# Verify EigenX CLI
eigenx --version

# Check you're in the right directory
cd /Users/mugdha/Desktop/blockchain/vault/examples/tee-service-template
pwd
```

### Step 2: Authenticate with EigenX (1 minute)

**Option A: Use Existing Wallet**

```bash
eigenx auth login
# Enter your private key when prompted
```

**Option B: Generate New Wallet**

```bash
eigenx auth generate --store
# A new wallet will be created and stored securely
```

**Check Your Address:**

```bash
eigenx auth whoami
```

Save this address! You'll need ETH here for deployment.

### Step 3: Get ETH for Deployment (2 minutes)

#### For Testnet (Sepolia):

```bash
# Switch to Sepolia
eigenx env set sepolia
```

Get Sepolia ETH from:
- https://cloud.google.com/application/web3/faucet/ethereum/sepolia
- https://www.alchemy.com/faucets/ethereum-sepolia

#### For Mainnet:

Send some ETH to your wallet address from `eigenx auth whoami`

**Verify Balance:**

```bash
eigenx auth whoami
# Should show your ETH balance
```

### Step 4: Configure Environment Variables (2 minutes)

```bash
# Copy example
cp .env.example .env

# Edit with your settings
nano .env  # or use your favorite editor
```

**Required Configuration:**

```env
# Server
PORT=8080
NODE_ENV=production

# Payment Configuration
PRICE_USDC=0.05
MERCHANT_WALLET=0xYourMerchantWalletAddress
MERCHANT_PRIVATE_KEY=0xYourPrivateKeyForSettlement

# Network (choose one)
# For Testnet:
NETWORK=base-sepolia
USDC_ADDRESS=0x036CbD53842c5426634e7929541eC2318f3dCF7e
CHAIN_ID=84532
BASE_RPC_URL=https://sepolia.base.org

# For Mainnet:
# NETWORK=base
# USDC_ADDRESS=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
# CHAIN_ID=8453
# BASE_RPC_URL=https://mainnet.base.org

# Payment Settlement
ENABLE_REAL_SETTLEMENT=true

# Don't set these - EigenCompute will auto-inject:
# MNEMONIC=<auto-generated by KMS>
# EIGEN_IMAGE_DIGEST=<auto-set>
# EIGEN_ATTESTATION_URL=<auto-set>
```

**Important Notes:**

- `MNEMONIC` - **DO NOT SET THIS!** EigenCompute auto-generates a secure mnemonic via KMS
- `MERCHANT_WALLET` - Your wallet that receives payments
- `MERCHANT_PRIVATE_KEY` - Only needed if `ENABLE_REAL_SETTLEMENT=true`

**For Development/Testing:**

Set `ENABLE_REAL_SETTLEMENT=false` to use simulated transactions (no real USDC transfer).

### Step 5: Login to Docker (30 seconds)

```bash
docker login
# Enter your Docker Hub credentials
```

### Step 6: Subscribe to EigenCompute Billing (2 minutes)

```bash
eigenx billing subscribe
```

This will:
1. Open payment portal in your browser
2. Prompt you to enter payment details
3. Subscribe you to EigenCompute

**Pricing:**
- Currently using testnet pricing even for mainnet (promotional period until 12/31/2025)

### Step 7: Deploy to TEE! ðŸš€ (3-5 minutes)

**Option A: Let EigenX CLI Handle Everything (Recommended)**

```bash
# EigenX will automatically:
# 1. Build Docker image (linux/amd64)
# 2. Push to your Docker registry
# 3. Deploy to TEE
eigenx app deploy
```

The CLI will prompt you for:
- App name (e.g., "my-x402-service")
- Dockerfile path (default: ./Dockerfile)
- .env path (default: ./.env)

**Option B: Manual Build & Deploy**

If you want more control:

```bash
# 1. Build image
docker build --platform linux/amd64 -t yourusername/x402-service:v1 .

# 2. Push to registry
docker push yourusername/x402-service:v1

# 3. Deploy
eigenx app deploy yourusername/x402-service:v1
```

**Deployment Output:**

```
Building Docker image...
âœ“ Image built successfully

Pushing to registry...
âœ“ Image pushed: yourusername/x402-service:v1

Deploying to TEE...
âœ“ TEE instance created
âœ“ Application deployed

App Details:
  Name: my-x402-service
  App ID: app_abc123xyz
  Instance IP: 12.34.56.78
  Status: Running
  TEE: Intel TDX (Enabled)

Environment:
  PORT: 8080
  MNEMONIC: <KMS-generated>
  EIGEN_IMAGE_DIGEST: sha256:abc123...
  EIGEN_ATTESTATION_URL: https://...
```

### Step 8: Verify Deployment (1 minute)

**Check App Status:**

```bash
eigenx app info
```

**View Logs:**

```bash
eigenx app logs

# Or stream logs in real-time
eigenx app logs --follow
```

**Test Health Endpoint:**

```bash
# Get your instance IP from 'eigenx app info'
curl http://INSTANCE_IP:8080/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "TEE Service Template",
  "timestamp": "2025-01-15T12:00:00Z",
  "tee": {
    "imageDigest": "sha256:abc123...",
    "attestationAvailable": true
  }
}
```

### Step 9: Test Payment Flow (2 minutes)

**Test 402 Response:**

```bash
# This should return 402 Payment Required
curl -X POST http://INSTANCE_IP:8080/api/generate-text \
  -H "Content-Type: application/json" \
  -d '{"prompt": "Hello world", "seed": 42}'
```

Expected response:
```json
{
  "error": "Payment Required",
  "paymentRequired": {
    "x402Version": 1,
    "accepts": [
      {
        "scheme": "exact",
        "network": "base-sepolia",
        "asset": "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
        "payTo": "0xYourMerchantWallet",
        "maxAmountRequired": "50000",
        "resource": "/api/generate-text",
        "description": "AI inference job"
      }
    ]
  }
}
```

âœ… **If you see this, your TEE service is working perfectly!**

### Step 10: Get Your Public URL (Optional)

For production, you'll want a public URL. EigenCompute provides options:

**Option 1: Use Instance IP**

Your app is accessible at: `http://INSTANCE_IP:8080`

**Option 2: Set Up Custom Domain with TLS**

See EigenCompute docs on "Configure TLS" to:
1. Get a domain name
2. Configure DNS
3. Enable HTTPS

### Step 11: Update Your Widget (30 seconds)

Update your website to use the deployed TEE service:

```html
<eigenx402-widget
  api-url="http://INSTANCE_IP:8080"
  endpoint="/api/generate-text"
  price="0.05"
  title="AI Text Generator"
  mode="ai">
</eigenx402-widget>

<script src="https://cdn.yoursite.com/widget.js"></script>
```

Or use the React component:

```tsx
<EigenPayWidget
  apiUrl="http://INSTANCE_IP:8080"
  endpoint="/api/generate-text"
  price="0.05"
  title="AI Text Generator"
  mode="ai"
/>
```

### Step 12: Test End-to-End (3 minutes)

1. Open your website with the widget
2. Click "Connect Wallet"
3. Switch to Base Sepolia network
4. Enter a prompt
5. Click "Pay & Access"
6. Sign the payment authorization in MetaMask
7. Get response with cryptographic proof!

**Check Payment Transaction:**

Visit BaseScan to verify the payment:
- Testnet: https://sepolia.basescan.org/tx/TX_HASH
- Mainnet: https://basescan.org/tx/TX_HASH

---

## Management Commands

### View App Info

```bash
eigenx app info
```

### View Logs

```bash
# View recent logs
eigenx app logs

# Stream in real-time
eigenx app logs --follow

# Filter by level
eigenx app logs --level error
```

### Update Your App

After making code or config changes:

```bash
eigenx app upgrade
```

This will rebuild and redeploy with the latest changes.

### Restart App

```bash
eigenx app restart
```

### Delete App

```bash
eigenx app delete
```

---

## Troubleshooting

### Build Fails

**Error: "platform mismatch"**

```bash
# Make sure Dockerfile has:
FROM --platform=linux/amd64 node:18-alpine
```

### Deployment Fails

**Error: "insufficient funds"**

```bash
# Check your ETH balance
eigenx auth whoami

# Get more ETH (see Step 3)
```

**Error: "billing not configured"**

```bash
# Subscribe to billing
eigenx billing subscribe
```

### App Not Starting

```bash
# Check logs for errors
eigenx app logs

# Common issues:
# - Missing environment variables in .env
# - Port conflicts (make sure PORT=8080)
# - Application crashes on startup
```

### Payment Verification Fails

**402 response not working:**

```bash
# Check logs
eigenx app logs | grep "Payment"

# Verify MERCHANT_WALLET is set in .env
# Verify USDC_ADDRESS matches your network
```

**Signature verification fails:**

```bash
# Make sure client is on the same network
# Check that NETWORK matches (base-sepolia or base)
# Verify USDC_ADDRESS is correct for your network
```

### Can't Access from Internet

**App only accessible locally:**

Make sure your app binds to `0.0.0.0`, not `localhost`:

```typescript
app.listen(PORT, '0.0.0.0', () => {
  // ...
});
```

---

## Production Checklist

Before going to mainnet:

### Security
- [ ] Switch to Base Mainnet (not Sepolia)
- [ ] Use production MERCHANT_WALLET and MERCHANT_PRIVATE_KEY
- [ ] Set `ENABLE_REAL_SETTLEMENT=true`
- [ ] Verify TEE is enabled (check `eigenx app info`)
- [ ] Store sensitive keys in EigenCompute secrets (not .env)

### Configuration
- [ ] Update .env with mainnet values:
  ```env
  NETWORK=base
  CHAIN_ID=8453
  USDC_ADDRESS=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
  BASE_RPC_URL=https://mainnet.base.org
  ```
- [ ] Set appropriate prices
- [ ] Configure rate limiting in your service code

### Testing
- [ ] Test all endpoints with 402 flow
- [ ] Test payment verification with small amounts
- [ ] Verify on-chain settlement on BaseScan
- [ ] Verify TEE attestation in responses
- [ ] Load test your service

### Monitoring
- [ ] Set up log monitoring: `eigenx app logs --follow`
- [ ] Monitor payment transactions
- [ ] Set up alerts for errors
- [ ] Track resource usage

---

## Environment Variables Reference

| Variable | Description | Required | Auto-Set by TEE |
|----------|-------------|----------|-----------------|
| `PORT` | Server port | Yes | No |
| `PRICE_USDC` | Default price | Yes | No |
| `MERCHANT_WALLET` | Payment receiver | Yes | No |
| `MERCHANT_PRIVATE_KEY` | For settlement | Yes (if real settlement) | No |
| `NETWORK` | Blockchain network | Yes | No |
| `USDC_ADDRESS` | USDC contract | Yes | No |
| `ENABLE_REAL_SETTLEMENT` | Real payments | Yes | No |
| `MNEMONIC` | Wallet mnemonic | No (auto-generated) | **Yes (KMS)** |
| `EIGEN_IMAGE_DIGEST` | Container hash | No | **Yes** |
| `EIGEN_ATTESTATION_URL` | TEE attestation | No | **Yes** |

**Important:** Don't set variables marked "Auto-Set by TEE" - EigenCompute injects these automatically!

---

## Support

- **EigenCompute Docs**: https://docs.eigencloud.xyz
- **GitHub Issues**: https://github.com/yourusername/eigenx402/issues
- **EigenCompute Discord**: https://discord.gg/eigencompute
- **Talk to Team**: https://eigencloud.xyz/contact

---

**You're Ready to Deploy! ðŸš€**

Run: `eigenx app deploy`
